<!DOCTYPE html>

<head>
    <title>visualizations - streaming</title>
    <meta charset="utf-8">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <style>

    body {
        background-color: #EEE;
    }

    svg {
        display: block;
        margin: auto;
    }
    
    rect {
        fill: coral;
    }

    text {
        fill: darkslategrey;
        font: 10px sans-serif;
        text-anchor: middle;
    }

    </style>

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script type="module">
        import streaming, { pointMaker } from './streaming.js';

        console.debug('building chart');

        streaming().then(args => {
            console.debug('finished building chart!');

            const y = args.y, x = args.x, bar = args.bar, height = args.width, width = args.width, barWidth = args.barWidth

            console.log('creating and inserting points into the chart now');

            for (let i = 0; i < 5; i++) {
                const p = pointMaker();
                args.bar.data([p], async function(d, i, g) { 
                    // const v = await d;
                    // console.log('d,i,v,g:', d, i, v, g);
                    return await d; 
                })
                    .join(enter => enter
                            .append('g')
                            .attr('class', 'bar')
                            .attr('transform', function (d, i) { return `translate(${i * args.barWidth},0)`; }) // TODO could be done in more of a random order
                    );
            }

            console.log('post loop')

            bar.append('rect')
                .attr('y', async function (d) {
                    const val = await d;
                    console.log('y', val);
                    return y(val.y);
                })
                .attr('width', barWidth - 1)
                .attr('height', async function (d) {
                    const val = await d;
                    console.log('height', val)
                    return height - y(val.y);
                });

            bar.append('text')
                .attr('x', barWidth / 2)
                .attr('dy', '.75')
                .attr('y', 8)
                .text(async function (d) {
                    const val = await d;
                    console.log('text', val)
                    return val.y;
                });

            console.debug('end');
        })
        
    </script>
</head>

<body></body>

</html>